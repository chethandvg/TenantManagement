@page "/billing/invoice-runs/{Id:guid}"
@attribute [Authorize]

<PageTitle>Invoice Run Details</PageTitle>

<MudStack Spacing="4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h4">Invoice Run Details</MudText>
        <MudButton Variant="Variant.Text" Color="Color.Secondary" Href="/billing/invoice-runs" StartIcon="@Icons.Material.Filled.ArrowBack">
            Back to List
        </MudButton>
    </MudStack>

    <BusyBoundary Retry="LoadInvoiceRunAsync">
        @if (_invoiceRun != null)
        {
            <!-- Run Header -->
            <MudPaper Elevation="2" Class="pa-4">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.h6">Run #@_invoiceRun.RunNumber</MudText>
                            <MudText><strong>Billing Period:</strong> @_invoiceRun.BillingPeriodStart.ToString("yyyy-MM-dd") to @_invoiceRun.BillingPeriodEnd.ToString("yyyy-MM-dd")</MudText>
                            @if (_invoiceRun.StartedAtUtc.HasValue)
                            {
                                <MudText><strong>Started:</strong> @_invoiceRun.StartedAtUtc.Value.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                            }
                            @if (_invoiceRun.CompletedAtUtc.HasValue)
                            {
                                <MudText><strong>Completed:</strong> @_invoiceRun.CompletedAtUtc.Value.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                            }
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudText><strong>Status:</strong></MudText>
                                @GetStatusChip(_invoiceRun.Status)
                            </MudStack>
                        </MudStack>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.h6">Summary</MudText>
                            <MudText><strong>Total Leases:</strong> @_invoiceRun.TotalLeases</MudText>
                            <MudText Color="Color.Success"><strong>Success:</strong> @_invoiceRun.SuccessCount</MudText>
                            <MudText Color="Color.Error"><strong>Failed:</strong> @_invoiceRun.FailureCount</MudText>
                            @if (!string.IsNullOrEmpty(_invoiceRun.ErrorMessage))
                            {
                                <MudAlert Severity="Severity.Error" Dense="true">@_invoiceRun.ErrorMessage</MudAlert>
                            }
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <!-- Run Items -->
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h6">Run Items</MudText>
                    
                    @if (_invoiceRun.Items == null || !_invoiceRun.Items.Any())
                    {
                        <MudAlert Severity="Severity.Info">No run items found.</MudAlert>
                    }
                    else
                    {
                        <MudDataGrid Items="@_invoiceRun.Items" Hover="true" Dense="true" Striped="true">
                            <Columns>
                                <PropertyColumn Property="x => x.LeaseNumber" Title="Lease #" />
                                <TemplateColumn Title="Status">
                                    <CellTemplate>
                                        @if (context.Item.IsSuccess)
                                        {
                                            <MudChip Color="Color.Success" Size="Size.Small">Success</MudChip>
                                        }
                                        else
                                        {
                                            <MudChip Color="Color.Error" Size="Size.Small">Failed</MudChip>
                                        }
                                    </CellTemplate>
                                </TemplateColumn>
                                <TemplateColumn Title="Invoice">
                                    <CellTemplate>
                                        @if (!string.IsNullOrEmpty(context.Item.InvoiceNumber))
                                        {
                                            <MudLink Href="@($"/billing/invoices/{context.Item.InvoiceId}")">
                                                @context.Item.InvoiceNumber
                                            </MudLink>
                                        }
                                        else
                                        {
                                            <MudText>-</MudText>
                                        }
                                    </CellTemplate>
                                </TemplateColumn>
                                <TemplateColumn Title="Message">
                                    <CellTemplate>
                                        @if (!string.IsNullOrEmpty(context.Item.ErrorMessage))
                                        {
                                            <MudText Color="Color.Error">@context.Item.ErrorMessage</MudText>
                                        }
                                        else
                                        {
                                            <MudText>-</MudText>
                                        }
                                    </CellTemplate>
                                </TemplateColumn>
                            </Columns>
                            <PagerContent>
                                <MudDataGridPager T="InvoiceRunItemDto" />
                            </PagerContent>
                        </MudDataGrid>
                    }
                </MudStack>
            </MudPaper>

            @if (!string.IsNullOrEmpty(_invoiceRun.Notes))
            {
                <MudPaper Elevation="2" Class="pa-4">
                    <MudText Typo="Typo.h6">Notes</MudText>
                    <MudText>@_invoiceRun.Notes</MudText>
                </MudPaper>
            }
        }
    </BusyBoundary>
</MudStack>
