@page "/billing/utility-statements"
@page "/billing/utility-statements/{LeaseId:guid}"
@attribute [Authorize]

<PageTitle>Utility Statements</PageTitle>

<MudStack Spacing="4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h4">Utility Statements</MudText>
        @if (LeaseId.HasValue)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="ShowCreateDialog">
                Create Statement
            </MudButton>
        }
    </MudStack>

    @if (!LeaseId.HasValue)
    {
        <MudPaper Elevation="2" Class="pa-4">
            <MudText>Please select a lease to manage utility statements.</MudText>
        </MudPaper>
    }
    else
    {
        <BusyBoundary Retry="LoadStatementsAsync">
            @if (_statements == null || !_statements.Any())
            {
                <MudAlert Severity="Severity.Info">No utility statements found.</MudAlert>
            }
            else
            {
                <MudDataGrid Items="@_statements" Hover="true" Dense="true" Striped="true">
                    <Columns>
                        <TemplateColumn Title="Utility Type">
                            <CellTemplate>@context.Item.UtilityType.ToString()</CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Property="x => x.BillingPeriodStart" Title="Period Start" Format="yyyy-MM-dd" />
                        <PropertyColumn Property="x => x.BillingPeriodEnd" Title="Period End" Format="yyyy-MM-dd" />
                        <TemplateColumn Title="Type">
                            <CellTemplate>
                                @(context.Item.IsMeterBased ? "Meter-Based" : "Amount-Based")
                            </CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Property="x => x.TotalAmount" Title="Total" Format="C" />
                        <TemplateColumn Title="Actions">
                            <CellTemplate>
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Primary" />
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                </MudDataGrid>
            }
        </BusyBoundary>
    }
</MudStack>

<MudDialog @bind-IsVisible="_showCreateDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Create Utility Statement</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="3">
            <MudSelect T="UtilityType" Label="Utility Type" @bind-Value="_form.UtilityType" Required="true">
                <MudSelectItem Value="@UtilityType.Electricity">Electricity</MudSelectItem>
                <MudSelectItem Value="@UtilityType.Water">Water</MudSelectItem>
                <MudSelectItem Value="@UtilityType.Gas">Gas</MudSelectItem>
            </MudSelect>
            
            <MudStack Row="true" Spacing="2">
                <MudDatePicker Label="Period Start" @bind-Date="_formPeriodStart" DateFormat="yyyy-MM-dd" Required="true" />
                <MudDatePicker Label="Period End" @bind-Date="_formPeriodEnd" DateFormat="yyyy-MM-dd" Required="true" />
            </MudStack>
            
            <MudSwitch T="bool" @bind-Checked="_form.IsMeterBased" Label="Meter-Based" Color="Color.Primary" />
            
            @if (_form.IsMeterBased)
            {
                <MudNumericField @bind-Value="_form.PreviousReading" Label="Previous Reading" />
                <MudNumericField @bind-Value="_form.CurrentReading" Label="Current Reading" />
            }
            else
            {
                <MudNumericField @bind-Value="_form.DirectBillAmount" Label="Amount" Format="N2" />
            }
            
            <MudTextField @bind-Value="_form.Notes" Label="Notes" Lines="3" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseCreateDialog">Cancel</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="CreateStatementAsync">Create</MudButton>
    </DialogActions>
</MudDialog>
