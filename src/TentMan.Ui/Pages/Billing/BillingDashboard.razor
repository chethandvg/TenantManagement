@page "/billing/dashboard"
@attribute [Authorize]

<PageTitle>Billing Dashboard</PageTitle>

<MudStack Spacing="4">
    <MudText Typo="Typo.h4">Billing Dashboard</MudText>

    <BusyBoundary Retry="LoadDashboardDataAsync">
        @if (_invoiceStats != null)
        {
            <!-- Statistics Cards -->
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="2">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">Due This Month</MudText>
                                    <MudIcon Icon="@Icons.Material.Filled.Receipt" Color="Color.Primary" />
                                </MudStack>
                                <MudText Typo="Typo.h3">@_invoiceStats.TotalDueThisMonth</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @_invoiceStats.TotalAmountDueThisMonth.ToString("C")
                                </MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="2">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">Overdue</MudText>
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Error" />
                                </MudStack>
                                <MudText Typo="Typo.h3">@_invoiceStats.OverdueCount</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    @_invoiceStats.OverdueAmount.ToString("C")
                                </MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="2">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">Draft Invoices</MudText>
                                    <MudIcon Icon="@Icons.Material.Filled.Edit" Color="Color.Info" />
                                </MudStack>
                                <MudText Typo="Typo.h3">@_invoiceStats.DraftCount</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>

                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="2">
                        <MudCardContent>
                            <MudStack Spacing="2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">Total Invoices</MudText>
                                    <MudIcon Icon="@Icons.Material.Filled.Assignment" Color="Color.Success" />
                                </MudStack>
                                <MudText Typo="Typo.h3">@_invoiceStats.TotalCount</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>

            <!-- Actions -->
            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.PlayArrow"
                           OnClick="GenerateMonthlyInvoicesAsync">
                    Generate Monthly Invoices
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" 
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="LoadDashboardDataAsync">
                    Refresh
                </MudButton>
            </MudStack>

            <!-- Recent Invoices -->
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h6">Recent Invoices</MudText>
                    
                    @if (_recentInvoices == null || !_recentInvoices.Any())
                    {
                        <MudAlert Severity="Severity.Info">No recent invoices found.</MudAlert>
                    }
                    else
                    {
                        <MudDataGrid Items="@_recentInvoices" Hover="true" Dense="true" Striped="true">
                            <Columns>
                                <PropertyColumn Property="x => x.InvoiceNumber" Title="Invoice #" />
                                <PropertyColumn Property="x => x.InvoiceDate" Title="Date" Format="yyyy-MM-dd" />
                                <PropertyColumn Property="x => x.DueDate" Title="Due Date" Format="yyyy-MM-dd" />
                                <TemplateColumn Title="Status">
                                    <CellTemplate>
                                        @GetStatusChip(context.Item.Status)
                                    </CellTemplate>
                                </TemplateColumn>
                                <PropertyColumn Property="x => x.TotalAmount" Title="Total" Format="C" />
                                <TemplateColumn Title="Actions" Sortable="false">
                                    <CellTemplate>
                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" 
                                                       Href="@($"/billing/invoices/{context.Item.Id}")" Color="Color.Primary" />
                                    </CellTemplate>
                                </TemplateColumn>
                            </Columns>
                        </MudDataGrid>
                        
                        <MudStack Row="true" Justify="Justify.FlexEnd">
                            <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/billing/invoices">
                                View All Invoices
                            </MudButton>
                        </MudStack>
                    }
                </MudStack>
            </MudPaper>
        }
    </BusyBoundary>
</MudStack>
