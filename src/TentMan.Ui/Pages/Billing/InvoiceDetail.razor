@page "/billing/invoices/{Id:guid}"
@attribute [Authorize]

<PageTitle>Invoice Details</PageTitle>

<MudStack Spacing="4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h4">Invoice Details</MudText>
        <MudButton Variant="Variant.Text" Color="Color.Secondary" Href="/billing/invoices" StartIcon="@Icons.Material.Filled.ArrowBack">
            Back to List
        </MudButton>
    </MudStack>

    <BusyBoundary Retry="LoadInvoiceAsync">
        @if (_invoice != null)
        {
            <!-- Invoice Header -->
            <MudPaper Elevation="2" Class="pa-4">
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.h6">Invoice #@_invoice.InvoiceNumber</MudText>
                            <MudStack Row="true" Spacing="2">
                                <MudText><strong>Date:</strong> @_invoice.InvoiceDate.ToString("yyyy-MM-dd")</MudText>
                                <MudText><strong>Due Date:</strong> @_invoice.DueDate.ToString("yyyy-MM-dd")</MudText>
                            </MudStack>
                            <MudText><strong>Billing Period:</strong> @_invoice.BillingPeriodStart.ToString("yyyy-MM-dd") to @_invoice.BillingPeriodEnd.ToString("yyyy-MM-dd")</MudText>
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudText><strong>Status:</strong></MudText>
                                @GetStatusChip(_invoice.Status)
                            </MudStack>
                        </MudStack>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudStack Spacing="2" AlignItems="AlignItems.End">
                            @if (_invoice.IssuedAtUtc.HasValue)
                            {
                                <MudText><strong>Issued:</strong> @_invoice.IssuedAtUtc.Value.ToString("yyyy-MM-dd HH:mm")</MudText>
                            }
                            @if (_invoice.VoidedAtUtc.HasValue)
                            {
                                <MudText Color="Color.Error"><strong>Voided:</strong> @_invoice.VoidedAtUtc.Value.ToString("yyyy-MM-dd HH:mm")</MudText>
                                @if (!string.IsNullOrEmpty(_invoice.VoidReason))
                                {
                                    <MudText Color="Color.Error"><strong>Reason:</strong> @_invoice.VoidReason</MudText>
                                }
                            }
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <!-- Actions -->
            <MudStack Row="true" Spacing="2">
                @if (_invoice.Status == InvoiceStatus.Draft)
                {
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Send"
                               OnClick="IssueInvoiceAsync">
                        Issue Invoice
                    </MudButton>
                }
                @if (_invoice.Status == InvoiceStatus.Issued || _invoice.Status == InvoiceStatus.PartiallyPaid)
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" 
                               StartIcon="@Icons.Material.Filled.Cancel"
                               OnClick="ShowVoidDialogAsync">
                        Void Invoice
                    </MudButton>
                }
            </MudStack>

            <!-- Line Items -->
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h6">Line Items</MudText>
                    
                    <MudTable Items="@_invoice.Lines" Hover="true" Dense="true" Striped="true">
                        <HeaderContent>
                            <MudTh>Line #</MudTh>
                            <MudTh>Charge Type</MudTh>
                            <MudTh>Description</MudTh>
                            <MudTh Style="text-align: right">Quantity</MudTh>
                            <MudTh Style="text-align: right">Unit Price</MudTh>
                            <MudTh Style="text-align: right">Amount</MudTh>
                            <MudTh Style="text-align: right">Tax</MudTh>
                            <MudTh Style="text-align: right">Total</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Line #">@context.LineNumber</MudTd>
                            <MudTd DataLabel="Charge Type">@context.ChargeTypeName</MudTd>
                            <MudTd DataLabel="Description">@context.Description</MudTd>
                            <MudTd DataLabel="Quantity" Style="text-align: right">@context.Quantity</MudTd>
                            <MudTd DataLabel="Unit Price" Style="text-align: right">@context.UnitPrice.ToString("C")</MudTd>
                            <MudTd DataLabel="Amount" Style="text-align: right">@context.Amount.ToString("C")</MudTd>
                            <MudTd DataLabel="Tax" Style="text-align: right">@context.TaxAmount.ToString("C")</MudTd>
                            <MudTd DataLabel="Total" Style="text-align: right"><strong>@context.TotalAmount.ToString("C")</strong></MudTd>
                        </RowTemplate>
                    </MudTable>
                    
                    <!-- Totals -->
                    <MudDivider />
                    <MudStack Spacing="1" Style="max-width: 400px; margin-left: auto;">
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Subtotal:</MudText>
                            <MudText>@_invoice.SubTotal.ToString("C")</MudText>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Tax:</MudText>
                            <MudText>@_invoice.TaxAmount.ToString("C")</MudText>
                        </MudStack>
                        <MudDivider />
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.h6">Total:</MudText>
                            <MudText Typo="Typo.h6">@_invoice.TotalAmount.ToString("C")</MudText>
                        </MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText>Paid:</MudText>
                            <MudText Color="Color.Success">@_invoice.PaidAmount.ToString("C")</MudText>
                        </MudStack>
                        <MudDivider />
                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                            <MudText Typo="Typo.h6">Balance:</MudText>
                            <MudText Typo="Typo.h6" Color="@(_invoice.BalanceAmount > 0 ? Color.Error : Color.Success)">
                                @_invoice.BalanceAmount.ToString("C")
                            </MudText>
                        </MudStack>
                    </MudStack>
                </MudStack>
            </MudPaper>

            @if (!string.IsNullOrEmpty(_invoice.Notes))
            {
                <MudPaper Elevation="2" Class="pa-4">
                    <MudText Typo="Typo.h6">Notes</MudText>
                    <MudText>@_invoice.Notes</MudText>
                </MudPaper>
            }
        }
    </BusyBoundary>
</MudStack>

@* Void Dialog *@
<MudDialog @bind-IsVisible="_showVoidDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">Void Invoice</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="2">
            <MudText>Are you sure you want to void this invoice? This action cannot be undone.</MudText>
            <MudTextField @bind-Value="_voidReason" Label="Void Reason" Lines="3" Required="true" />
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseVoidDialog">Cancel</MudButton>
        <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="VoidInvoiceAsync">Void Invoice</MudButton>
    </DialogActions>
</MudDialog>
