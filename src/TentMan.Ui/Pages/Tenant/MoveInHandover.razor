@page "/tenant/move-in"
@attribute [Authorize]
@using Microsoft.JSInterop

<PageTitle>Move-In Handover - TentMan</PageTitle>

<BusyBoundary Retry="LoadDataAsync">
    <MudStack Spacing="4">
        <MudText Typo="Typo.h4">Move-In Handover Checklist</MudText>

        @if (_handover != null)
        {
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Spacing="3">
                    <MudText Typo="Typo.h6">Unit: @_handover.UnitNumber</MudText>
                    <MudText Typo="Typo.body2">Building: @_handover.BuildingName</MudText>
                    <MudText Typo="Typo.body2">Date: @_handover.Date.ToString("dd MMM yyyy")</MudText>
                    
                    @if (_isSubmitted)
                    {
                        <MudAlert Severity="Severity.Success" Class="mt-2">
                            <MudStack Row="true" AlignItems="AlignItems.Center">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" />
                                <MudText>This handover has been completed and signed.</MudText>
                            </MudStack>
                        </MudAlert>
                    }
                    
                    <MudDivider />

                    <MudText Typo="Typo.subtitle1">Checklist Items</MudText>
                    
                    @foreach (var item in _handover.ChecklistItems)
                    {
                        <MudCard Elevation="1" Class="pa-3">
                            <MudStack Spacing="2">
                                <MudText Typo="Typo.body1">
                                    <strong>@item.Category</strong> - @item.ItemName
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Primary">
                                    Condition: @item.Condition.ToString()
                                </MudText>
                                <MudTextField @bind-Value="item.Remarks"
                                            Label="Remarks"
                                            Variant="Variant.Outlined"
                                            Lines="2"
                                            FullWidth="true"
                                            ReadOnly="_isSubmitted" />
                            </MudStack>
                        </MudCard>
                    }

                    @if (_handover.MeterReadings.Any())
                    {
                        <MudDivider Class="mt-4" />
                        <MudText Typo="Typo.subtitle1">Meter Readings</MudText>
                        
                        @foreach (var meter in _handover.MeterReadings)
                        {
                            <MudCard Elevation="1" Class="pa-3">
                                <MudStack Row="true" Spacing="3">
                                    <MudText Typo="Typo.body1">
                                        <strong>@meter.MeterType:</strong>
                                    </MudText>
                                    <MudText Typo="Typo.body1">@meter.Reading</MudText>
                                    <MudText Typo="Typo.caption">(@meter.ReadingDate.ToString("dd MMM yyyy"))</MudText>
                                </MudStack>
                            </MudCard>
                        }
                    }

                    @if (!_isSubmitted)
                    {
                        <MudDivider Class="mt-4" />
                        <MudTextField @bind-Value="_handover.Notes"
                                    Label="Additional Notes"
                                    Variant="Variant.Outlined"
                                    Lines="3"
                                    FullWidth="true"
                                    ReadOnly="_isSubmitted" />
                    }
                    else if (!string.IsNullOrEmpty(_handover.Notes))
                    {
                        <MudDivider Class="mt-4" />
                        <MudTextField @bind-Value="_handover.Notes"
                                    Label="Additional Notes"
                                    Variant="Variant.Outlined"
                                    Lines="3"
                                    FullWidth="true"
                                    ReadOnly="true" />
                    }

                    @if (!_isSubmitted)
                    {
                        <MudDivider Class="mt-4" />

                        <MudStack Spacing="2" Class="mt-4">
                            <MudText Typo="Typo.subtitle1">Tenant Signature</MudText>
                            <MudText Typo="Typo.caption">Please draw your signature below</MudText>
                            
                            <MudPaper Elevation="1" Class="pa-2" Style="background-color: #f5f5f5;">
                                <canvas id="signatureCanvas" 
                                        width="600" 
                                        height="200" 
                                        style="border: 2px dashed #ccc; background-color: white; cursor: crosshair; touch-action: none;"></canvas>
                            </MudPaper>
                            
                            <MudButton Variant="Variant.Text" 
                                      Color="Color.Secondary"
                                      Size="Size.Small"
                                      OnClick="ClearSignature"
                                      StartIcon="@Icons.Material.Filled.Clear">
                                Clear Signature
                            </MudButton>
                        </MudStack>

                        @if (!string.IsNullOrEmpty(_error))
                        {
                            <MudAlert Severity="Severity.Error">@_error</MudAlert>
                        }

                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  Size="Size.Large"
                                  OnClick="SubmitHandover"
                                  Disabled="@(_isSubmitting || string.IsNullOrWhiteSpace(_signatureDataUrl))">
                            @if (_isSubmitting)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>Submitting...</span>
                            }
                            else
                            {
                                <span>Submit Handover Checklist</span>
                            }
                        </MudButton>
                    }
                </MudStack>
            </MudPaper>
        }
        else
        {
            <MudPaper Elevation="2" Class="pa-6">
                <MudStack AlignItems="AlignItems.Center" Spacing="3">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Large" Color="Color.Info" />
                    <MudText Typo="Typo.h6">No Handover Pending</MudText>
                    <MudText Typo="Typo.body1">
                        There is no move-in handover checklist pending at this time.
                    </MudText>
                </MudStack>
            </MudPaper>
        }
    </MudStack>
</BusyBoundary>
